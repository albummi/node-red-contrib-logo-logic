<script type="text/x-red" data-template-name="logo-or">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="LOGO OR">
  </div>

  <div class="form-row">
    <label for="node-input-inputsCount"><i class="fa fa-sign-in"></i> Anzahl Eingänge</label>
    <input type="number" id="node-input-inputsCount" min="2" max="8">
  </div>

  <div class="form-row">
    <label><i class="fa fa-bolt"></i> Nur bei Zustandsänderung senden</label>
    <input type="checkbox" id="node-input-emitOnChange" checked>
  </div>

  <div class="form-row">
    <label><i class="fa fa-exchange"></i> Eingangs-Topics (msg.topic)</label>
    <div id="topics-container"></div>
  </div>

  <div class="form-tips">
    Adressiere jeden Eingang über einen konfigurierten <code>msg.topic</code>-Wert. 
    <br>Reset: <code>msg.reset = true</code>
  </div>
</script>

<script type="text/x-red" data-help-name="logo-or">
  <p>LOGO-Style OR mit konfigurierten <code>msg.topic</code> je Eingang und Negierung.</p>
</script>

<script type="text/javascript">
(function() {
  function buildUI(count, topics, negs) {
    const c = $("#topics-container");
    c.empty();
    for (let i = 0; i < count; i++) {
      const tv = (topics && topics[i]) ? topics[i] : "";
      const ng = (negs && negs[i]) ? "checked" : "";
      c.append(
        `<div class="form-row" data-idx="${i}">
          <label>E${i+1}</label>
          <input type="text" class="topic-val" data-idx="${i}" placeholder="z.B. Keks" value="${$('<div/>').text(tv).html()}">
          <label style="margin-left:8px"><input type="checkbox" class="negate-flag" data-idx="${i}" ${ng}> Negieren</label>
        </div>`
      );
    }
  }

  RED.nodes.registerType('logo-or', {
    category: 'Logo',
    color: '#FFCC00',
    icon: 'font-awesome/fa-cogs',
    defaults: {
      name: { value: "" },
      inputsCount: { value: 2, required: true, validate: v => v >= 2 && v <= 8 },
      emitOnChange: { value: true },
      topicValues: { value: [] },
      negateInputs: { value: [] }
    },
    inputs: 1,
    outputs: 1,
    label: function() { return this.name || "LOGO OR"; },
    oneditprepare: function() {
      const self = this;
      const countEl = $("#node-input-inputsCount");
      const initCount = Math.max(2, Math.min(8, parseInt(countEl.val(), 10) || 2));
      buildUI(initCount, self.topicValues, self.negateInputs);
      countEl.on("change", function() {
        const c = Math.max(2, Math.min(8, parseInt($(this).val(), 10) || 2));
        buildUI(c, self.topicValues, self.negateInputs);
      });
    },
    oneditsave: function() {
      const count = Math.max(2, Math.min(8, parseInt($("#node-input-inputsCount").val(), 10) || 2));
      const topics = Array(count).fill("");
      const negs = Array(count).fill(false);
      $(".topic-val").each(function() {
        const idx = parseInt($(this).data("idx"), 10);
        if (!isNaN(idx) && idx < count) topics[idx] = $(this).val();
      });
      $(".negate-flag").each(function() {
        const idx = parseInt($(this).data("idx"), 10);
        if (!isNaN(idx) && idx < count) negs[idx] = $(this).is(":checked");
      });
      this.topicValues = topics;
      this.negateInputs = negs;
    }
  });
})();
</script>
