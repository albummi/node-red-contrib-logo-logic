<script type="text/x-red" data-template-name="logo-and">
  <div class="form-row"><label><i class="fa fa-tag"></i> Name</label><input type="text" id="node-input-name" placeholder="LOGO AND"></div>
  <div class="form-row"><label for="node-input-inputsCount"><i class="fa fa-sign-in"></i> Anzahl Eingänge</label><input type="number" id="node-input-inputsCount" min="2" max="8"></div>
  <div class="form-row"><label><i class="fa fa-bolt"></i> Nur bei Zustandsänderung senden</label><input type="checkbox" id="node-input-emitOnChange" checked></div>
  <div class="form-row"><label><i class="fa fa-exchange"></i> Eingangs-Topics</label><div id="topics-container"></div></div>
  <script type="text/javascript">
  (function() {
    function buildInputs(count, values, negs) {
      const c = $("#topics-container");
      c.empty();
      for(let i=0;i<count;i++) {
        const val = values[i]||"";
        const neg = negs[i] ? "checked" : "";
        c.append(`<div class="form-row" data-idx="${i}">
          <label>Eingang ${i+1}</label>
          <input type="text" class="topic-val" data-idx="${i}" placeholder="msg.topic == ?" value="${$('<div/>').text(val).html()}">
          <label style="margin-left:8px"><input type="checkbox" class="negate-flag" data-idx="${i}" ${neg}> Negieren</label>
        </div>`);
      }
    }
    RED.nodes.registerType('logo-and', {
      category: 'function', color: '#FFCC00', icon: 'font-awesome/fa-cogs',
      defaults: {
        name:{value:""}, inputsCount:{value:2,required:true,validate:v=>v>=2&&v<=8},
        topicValues:{value:[]}, negateInputs:{value:[]}, emitOnChange:{value:true}
      },
      inputs:1,outputs:1, label: function(){return this.name||"LOGO AND";},
      oneditprepare: function(){
        const self=this;
        buildInputs(parseInt($("#node-input-inputsCount").val(),10)||2, self.topicValues, self.negateInputs);
        $("#node-input-inputsCount").on("change",()=>{
          buildInputs(Math.max(2,Math.min(8,parseInt($("#node-input-inputsCount").val(),10)||2)), self.topicValues, self.negateInputs);
        });
      },
      oneditsave: function(){
        const count = Math.max(2,Math.min(8,parseInt($("#node-input-inputsCount").val(),10)||2));
        const vals = Array(count).fill("");
        const negs = Array(count).fill(false);
        $(".topic-val").each(function(){
          const idx = parseInt($(this).data("idx"),10);
          if(idx>=0&&idx<count) vals[idx] = $(this).val();
        });
        $(".negate-flag").each(function(){
          const idx = parseInt($(this).data("idx"),10);
          if(idx>=0&&idx<count) negs[idx] = $(this).is(":checked");
        });
        this.topicValues = vals; this.negateInputs = negs;
      }
    });
  })();
  </script>
</script>
<script type="text/x-red" data-help-name="logo-and">
  <p>AND-Gate: erlaubt per Eingang msg.topic festzulegen. Wird deaktiviert sobald msg.topic nicht mehr passt.</p>
</script>
